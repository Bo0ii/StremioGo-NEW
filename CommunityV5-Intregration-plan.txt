# StreamGo Native MPV Player Integration Plan

## Goal
Replace Chromium's HTML5 video player with MPV via a native Node.js addon, while keeping StreamGo's existing UI unchanged. Cross-platform (Windows, macOS, Linux) with HTML5 fallback.

---

## Core Priority

**Basic MPV playback working** — Stream loads and plays through MPV with Stremio UI controls fully synced. This is the v1 must-have.

---

## Design Decisions

### UX Decisions
| Area | Decision | Rationale |
|------|----------|-----------|
| **Fallback** | Notify user | Show subtle indicator when falling back to HTML5 |
| **Keyboard shortcuts** | Stremio's shortcuts | Forward Stremio's shortcuts to MPV (not MPV's input.conf) |
| **Track selection** | Stremio's UI | Use Stremio's subtitle/audio selector, forward choices to MPV |
| **Loading indicator** | Stremio's spinner | Show Stremio's loading UI until MPV is ready |
| **Fullscreen** | Keep existing | Use StreamGo's current fullscreen behavior |
| **Quality switching** | As-is | Stremio handles quality selection, MPV loads new stream |
| **Audio output** | System default | Always use system's default audio device |

### Technical Decisions
| Area | Decision | Rationale |
|------|----------|-----------|
| **Reference implementation** | Port directly | Adapt Community V5's approach for StreamGo's architecture |
| **Build approach** | Prebuilt binaries only | Ship compiled addon.node for all platforms |
| **Position saving** | Both systems | Sync to Stremio AND use MPV's watch-later as backup |
| **HDR handling** | User choice | Add setting for passthrough vs tone-mapping |
| **Logging** | Developer console | Log MPV events to Electron's dev console |
| **Config system** | Full system | User-editable mpv.conf, shader loading, script support |

---

## Scope

### In Scope (v1)
- [x] Basic MPV playback with controls synced
- [x] Watch Party full sync (play/pause/seek commands)
- [x] Full configuration system (mpv.conf, shaders, scripts)
- [x] Settings subpage in Plus Page
- [x] HTML5 fallback with user notification
- [x] Cross-platform (Windows, macOS, Linux)
- [x] Prebuilt binaries for all platforms
- [x] HDR passthrough/tone-map toggle setting

### Out of Scope (v1 — Defer)
| Feature | Reason |
|---------|--------|
| Ambilight integration | Requires MPV frame capture API |
| ThumbFast thumbnails | Nice-to-have, not essential |
| Discord RPC MPV integration | Keep using HTML5-based RPC for now |
| Screenshots | Skip for v1, add later |
| Subtitle customization | Power users can edit mpv.conf |
| Audio device selection | System default is sufficient |

---

## Architecture

### Current → Target
```
CURRENT:                              TARGET:
Electron Window                       Electron Window
└── Chromium (Stremio Web)           ├── Chromium (Stremio Web UI)
    └── HTML5 <video>                └── MPV (native, overlaid)
                                         └── Anime4K, HDR, hw decode
```

### Component Diagram
```
┌─────────────────────────────────────────────────────────────────┐
│                      Electron Main Process                       │
├─────────────────────────────────────────────────────────────────┤
│  main.ts ◄──► MpvNative.ts ◄──► mpv_addon.node (C++ N-API)     │
│     ▲              ▲                    ▲                        │
│     │ IPC          │                    │ libmpv                 │
│     ▼              ▼                    ▼                        │
│  preload.ts ◄──► NativePlayerInjector   MPV Rendering Surface   │
│                                         (HWND/NSView/X11)        │
└─────────────────────────────────────────────────────────────────┘
```

---

## Implementation Phases

### Phase 1: Native Addon Infrastructure
**Create directory structure and build system**

New files:
```
native/mpv/
├── binding.gyp           # node-gyp build config
├── package.json          # Native addon metadata
├── src/
│   ├── mpv_addon.cpp     # N-API implementation
│   ├── mpv_addon.h
│   └── event_helpers.cpp # mpv_node → JSON conversion
├── include/mpv/          # MPV headers (client.h, etc.)
└── lib/
    ├── win32-x64/        # libmpv-2.dll, mpv.lib
    ├── darwin-x64/       # libmpv.dylib
    ├── darwin-arm64/
    └── linux-x64/        # libmpv.so
```

### Phase 2: C++ Native Addon
**Port MPV integration from Community V5**

Reference: `stremio-community-v5-webview-windows/src/mpv/player.cpp`
Approach: Port directly with minor adaptations for StreamGo's architecture.

Key N-API exports:
| Function | Purpose |
|----------|---------|
| `initialize(hwnd)` | Create MPV, set window ID, init |
| `command(args[])` | Send commands (loadfile, seek, etc.) |
| `setProperty(name, value)` | Set volume, pause, tracks |
| `getProperty(name)` | Read current state |
| `observeProperty(name, id)` | Watch for changes |
| `handleEvents()` | Poll events, return as JSON array |
| `cleanup()` | Destroy MPV instance |

Critical: Set `wid` option BEFORE `mpv_initialize()` for proper embedding.

### Phase 3: TypeScript Wrapper
**JavaScript interface for main process**

New file: `src/native/MpvNative.ts`

```typescript
class MpvNativePlayer {
    initialize(window: BrowserWindow): Promise<boolean>
    loadFile(url: string): void
    play(): void
    pause(): void
    seek(seconds: number): void
    setVolume(volume: number): void
    setSubtitleTrack(id: number): void    // Forward from Stremio UI
    setAudioTrack(id: number): void       // Forward from Stremio UI
    onEvent(callback: (event: MpvEvent) => void): void
    cleanup(): void
}
```

Platform-specific window handle parsing:
- Windows: `readBigUInt64LE()` for HWND
- macOS: `readBigUInt64LE()` for NSView
- Linux: `readUInt32LE()` for X11 Window ID

### Phase 4: Main Process Integration
**Initialize MPV and handle IPC**

Modify: `src/main.ts`

```typescript
// After BrowserWindow creation, BEFORE loadURL
const mpvPlayer = new MpvNativePlayer();
const success = await mpvPlayer.initialize(mainWindow);

if (success) {
    setupNativePlayerIPC(mpvPlayer);
} else {
    // Fallback to HTML5 - notify user via IPC
    notifyFallbackMode();
}
```

New IPC channels in `src/constants/index.ts`:
```typescript
NATIVE_PLAYER_INIT: 'native-player-init',
NATIVE_PLAYER_LOAD: 'native-player-load',
NATIVE_PLAYER_COMMAND: 'native-player-command',
NATIVE_PLAYER_SET_PROPERTY: 'native-player-set-property',
NATIVE_PLAYER_EVENT: 'native-player-event',
NATIVE_PLAYER_RESIZE: 'native-player-resize',
NATIVE_PLAYER_STATUS: 'native-player-status',
NATIVE_PLAYER_FALLBACK: 'native-player-fallback',  // Notify fallback mode
```

### Phase 5: Renderer Integration
**Intercept video and route to MPV**

New file: `src/components/native-player-injector/nativePlayerInjector.ts`

Logic:
1. On `#/player` route, wait for Stremio's video element
2. Extract stream URL from video.src
3. Hide HTML5 video (`opacity: 0`, pause)
4. Send URL to main process via IPC
5. MPV renders in overlay, synced to video container position
6. Forward MPV events back to update Stremio's progress bar
7. Intercept Stremio's keyboard shortcuts and forward to MPV

Fallback handling:
- If MPV load fails, restore HTML5 video visibility
- Show subtle notification that native player isn't available

Position saving:
- Report position to Stremio's system for cloud sync
- Enable MPV's watch-later as local backup

### Phase 6: Configuration System
**MPV config, shaders, scripts**

Config directory:
```
%APPDATA%/streamgo/native-player/    (Windows)
~/Library/Application Support/streamgo/native-player/   (macOS)
~/.config/streamgo/native-player/    (Linux)

├── mpv.conf              # Player options
├── input.conf            # Keybindings (mostly disabled, Stremio handles)
├── shaders/Anime4K/      # Upscaling shaders
├── scripts/              # Lua scripts
└── watch_later/          # MPV's position saving
```

Default mpv.conf (from Community V5):
```
vo=gpu-next
hwdec=auto
cache=yes
cache-secs=60
demuxer-max-bytes=300000000
save-position-on-quit=yes
```

HDR setting exposed in UI:
```
# User can toggle via settings UI
tone-mapping=auto        # or passthrough based on user preference
```

### Phase 7: Settings UI
**Native player settings subpage in Plus Page**

New component: `src/components/native-player-settings/nativePlayerSettings.ts`

Settings exposed:
| Setting | Type | Description |
|---------|------|-------------|
| Enable Native Player | Toggle | Master on/off switch |
| HDR Mode | Dropdown | Passthrough / Tone-map / Auto |
| Hardware Decoding | Dropdown | Auto / None / Platform-specific |
| Enable Shaders | Toggle | Load Anime4K shaders |
| Shader Profile | Dropdown | Quality presets |

Config files remain editable for power users.

### Phase 8: Build & Packaging
**Cross-platform prebuilt binaries**

Update `package.json`:
```json
{
    "scripts": {
        "build:native": "cd native/mpv && node-gyp rebuild --target=28.0.0",
        "build:native:all": "npm run build:native:win && npm run build:native:mac && npm run build:native:linux"
    },
    "build": {
        "asarUnpack": ["**/mpv_addon.node", "**/libmpv*"],
        "extraResources": [
            { "from": "native/mpv/prebuilt/${os}-${arch}", "to": "native" }
        ]
    }
}
```

Prebuilt binaries directory:
```
native/mpv/prebuilt/
├── win32-x64/
│   ├── mpv_addon.node
│   └── libmpv-2.dll
├── darwin-x64/
│   ├── mpv_addon.node
│   └── libmpv.dylib
├── darwin-arm64/
│   ├── mpv_addon.node
│   └── libmpv.dylib
└── linux-x64/
    ├── mpv_addon.node
    └── libmpv.so
```

libmpv sources:
- Windows: sourceforge.net/projects/mpv-player-windows/files/libmpv/
- macOS: `brew install mpv` → extract dylib
- Linux: Extract from package or build

### Phase 9: Watch Party Integration
**Full sync with MPV**

Modify: `src/utils/PartyService.ts`

Route sync commands through native player when active:
| Command | Implementation |
|---------|----------------|
| Play | `mpvPlayer.play()` instead of `video.play()` |
| Pause | `mpvPlayer.pause()` instead of `video.pause()` |
| Seek | `mpvPlayer.seek(time)` instead of `video.currentTime = time` |
| Sync position | Read from MPV events, sync to party |

Fallback: If native player not active, use existing HTML5 logic.

---

## Files to Modify

| File | Changes |
|------|---------|
| `src/main.ts` | Initialize MpvNative after window creation, setup IPC handlers |
| `src/preload.ts` | Import and init nativePlayerInjector on player route |
| `src/constants/index.ts` | Add NATIVE_PLAYER_* IPC channels |
| `src/utils/PartyService.ts` | Route sync commands to native player |
| `src/components/plus-page/plusPage.ts` | Add native player settings subpage |
| `package.json` | Add native build scripts, electron-builder config |

## Files to Create

| File | Purpose |
|------|---------|
| `native/mpv/binding.gyp` | node-gyp build configuration |
| `native/mpv/src/mpv_addon.cpp` | N-API bindings for libmpv |
| `src/native/MpvNative.ts` | TypeScript wrapper for addon |
| `src/components/native-player-injector/nativePlayerInjector.ts` | Video interception |
| `src/components/native-player-settings/nativePlayerSettings.ts` | Settings UI |
| `src/components/native-player-settings/nativePlayerSettings.html` | Settings template |

---

## Verification Plan

1. **Basic Playback**: Load a stream URL, verify video plays through MPV (not HTML5)
2. **Controls**: Play/pause/seek from Stremio UI controls MPV correctly
3. **Position Saving**: Exit player, re-enter, verify resume works (both Stremio + MPV)
4. **Watch Party**: Two clients sync playback position via party service
5. **Track Selection**: Change subtitle/audio via Stremio UI, verify MPV switches
6. **Upscaling**: Enable Anime4K shader via settings, verify quality improvement
7. **HDR Toggle**: Switch HDR mode in settings, verify behavior changes
8. **Fallback**: Corrupt MPV binary, verify HTML5 player activates + notification shown
9. **Cross-Platform**: Test on Windows, macOS, Linux

---

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Native addon compile fails | Ship prebuilt binaries for all platforms |
| Window embedding breaks | Automatic fallback to HTML5 with notification |
| MPV crashes | Isolate in try/catch, fallback gracefully |
| libmpv missing | Bundle all DLLs/dylibs, check on startup |
| Shortcuts conflict | Stremio handles all shortcuts, forward to MPV |

---

## Dependencies

**NPM packages:**
- `node-addon-api` - N-API helper library
- `node-gyp` - Native compilation (dev only)

**System libraries (bundled as prebuilt):**
- `libmpv-2.dll` (Windows)
- `libmpv.dylib` (macOS x64 + arm64)
- `libmpv.so` (Linux)

**Reference files from Community V5:**
- `stremio-community-v5-webview-windows/src/mpv/player.cpp` - Port to N-API
- `stremio-community-v5-webview-windows/deps/libmpv/` - Copy binaries
- `portable_config/mpv.conf` - Default configuration
- `portable_config/shaders/Anime4K/` - Upscaling shaders
